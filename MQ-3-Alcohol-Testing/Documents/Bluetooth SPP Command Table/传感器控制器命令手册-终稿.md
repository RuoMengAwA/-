# 传感器控制器命令手册

## 序

### 目录

[TOC]

### 关于

**GitHub** @Challenger_0



## 更新日志

2022/4/15

### 新增

1. 新增**注意事项**
2. **命令表**新增**获取最后一次温湿度检测结果**和**强制刷新温湿度**命令
3. **错误返回**新增**重置命令缓冲区**命令

### 更改

1. **命令表**更改**检测酒精浓度**和**获取最后一次检测值**命令
2. **命令格式**补充格式说明

## 命令格式

此版使用JSON格式封装命令，发送命令实际上是发送JSON字符串…

**命令和返回值格式**

一条命令/返回值包括`cmd`和`param`两个字段，其中字段`cmd`为命令字，是一个整数；之后是多个参数字段，其内容参见命令表。

示例：

~~~json
{
    "cmd":0,
    "param1":"...",
    "param2":"..."
    ...
}
~~~

此外，一条命令/返回字符串总长不应超过127字节，所以命令字符串**最好删除空白字符**；返回字符串**不会有空白字符**。

所以实际发送的命令最好长这样，返回值的实际格式也如下所示：

~~~json
{"cmd":0,"param1":"...","param2":"..." ...}
~~~

下文示例为方便阅读，使用格式化后的JSON文本。

## 注意事项

1. 酒精检测**开始酒精检测**、**开始校准**和**持续检测**功能只能同时运行一个。如需使用其他功能，对于前二者，需等待它们执行完毕，对于后者，需使用**持续监测开关**命令手动关闭。
2. 在使用**持续检测**功能时，应当先执行校准程序；在连续使用该功能一段时间后，也应执行校准程序。
3. 上电后应使用**设置时间**命令调整时间，虽然不调整问题也不大。
4. 使用**强制刷新温湿度**命令的间隔应大于1秒。
5. **重启/复位**和**擦除/重置**命令执行成功时可能不会有返回，但是失败一定会有返回。

## 命令表

### 获取版本号

- **命令字** 0

- **命令参数** 无
- **返回参数** `version`版本号

命令示例

~~~json
{
    "cmd":0
}
~~~

返回示例

~~~json
{
    "cmd":0,
    "version":"Ver Demo"
}
~~~



### 检测酒精浓度

- **命令字** 1
- **命令参数** 无
- **返回参数**
  -  `raw`ADC源值  
  - `status`  命令执行状态 
    - `0` 成功 
    - `-1` 失败，酒精传感器被其他任务占用
  -  `air`推算空气中酒精浓度mg/L 
  -  `blood`推算血液中酒精浓度mg/100mL
  -  `temp`环境温度℃ 
  -  `humi`环境湿度%
- **备注** 可能需要30秒甚至更久才能得到返回值。如果执行失败，则会立刻返回，且返回值为最后一次检测结果。

命令示例

~~~json
{
    "cmd":1
}
~~~

返回示例

~~~json
{
    "cmd":1,
    "status":0,
    "raw":383,
    "air":0.000146,
    "blood":0.14,
    "temp":25,
    "humi":51
}
~~~



### 获取最后一次检测值

- **命令字** 2
- **命令参数** 无
- **返回参数** `raw`酒精检测ADC源值  `air`推算空气中酒精浓度mg/L  `blood`推算血液中酒精浓度mg/100mL `temp`环境温度℃ `humi`环境湿度%

命令示例

~~~json
{
    "cmd":2
}
~~~

返回示例

~~~json
{
    "cmd":2,
    "raw":383,
    "air":0.000146,
    "blood":0.14,
    "temp":25,
    "humi":51
}
~~~



### 开始校准

- **命令字** 3
- **命令参数** 无
- **返回参数** 
  - `status`  命令执行状态 
    - `0` 成功 
    - `-1` 失败，酒精传感器被其他任务占用

命令示例

~~~json
{
    "cmd":3
}
~~~

返回示例

~~~json
{
    "cmd":3,
    "status":0,
}
~~~



### 重启/复位

重启，不会复位flash中的设置

- **命令字** 4
- **命令参数** 
  - `confirn` 校验值，应为`restart`
- **返回参数** 
  - `status`  命令执行状态 
    - `0` 成功 
    - `-1` 失败，校验值错误

命令示例

~~~json
{
    "cmd":4,
    "confirn":"restart"
}
~~~

返回示例

~~~json
{
    "cmd":4,
    "status":0
}
~~~



### 擦除/重置

将所有(包括flash中的)设置恢复到默认值

- **命令字** 5
- **命令参数** 
  - `confirn` 校验值，应为`erase`
- **返回参数** 
  - `status`  命令执行状态 
    - `0` 成功 
    - `-1` 失败，校验值错误

命令示例

~~~json
{
    "cmd":5,
    "confirn":"erase"
}
~~~

返回示例

~~~json
{
    "cmd":5,
    "status":0
}
~~~



### 持续检测开关

设置是否持续检测…

- **命令字** 6
- **命令参数** 
  - `switch` 开关值
    - `0` 关闭
    - `1`  打开
    - 其他值 不做改变
- **返回参数** 
  - `switch`  调整后的值
    - `0` 关闭
    - `1` 打开



### 自动回传开关

设置是否自动回传…（在打开持续检测的情况下）

如需单次获取，使用**获取最后一次检测值**。

- **命令字** 7
- **命令参数** 
  - `switch` 开关值
    - `0` 关闭
    - `1`  打开
    - 其他值 不做改变
- **返回参数** 
  - `switch`  调整后的值
    - `0` 关闭
    - `1` 打开

### 传感器不断电开关

设置传感器是否在**单次测量**完成后自动断电…

打开有助于提升检测速度和精度，但是费电

- **命令字** 8
- **命令参数** 
  - `switch` 开关值
    - `0` 关闭
    - `1`  打开
    - 其他值 不做改变
- **返回参数** 
  - `switch`  调整后的值
    - `0` 关闭
    - `1` 打开

### 设置时间

就是设置时间，部分功能需要依赖时间…

可用范围：1970往后的136年

- **命令字** 9
- **命令参数** 
  - `yr` 年
  - `mon` 月
  - `day` 日
  - `hr` 时
  - `min` 分
  - `sec` 秒
- **返回参数** 
  - `status`  状态
    - `0` 失败，指定的时间不合法
    - `1` 成功



### 获取最后一次温湿度检测结果

一般情况温湿度是会自动刷新的，如非必要一般直接获取即可

- **命令字** 10
- **命令参数** 无
- **返回参数**
  - `temp` 温度，摄氏度
  - `humi` 湿度，百分比



### 强制刷新温湿度

一般用不到，除非必要…

- **命令字** 11
- **命令参数** 无
- **返回参数**
  - `status` 命令执行状态
    - `0`失败，温湿度传感器被占用
    - `1`成功

## 错误返回

### 错误返回

- **命令字** -1
- **返回参数**

  - `0` 命令过长/命令缓冲溢出；可能传输时丢失大括号

    此条和之前所有受影响的命令作废，需重新发送

  - `1` 命令格式有误/无法解析字串；可能传输时丢失字符
  
  - `2` 参数字段/类型有误/找不到参数
  
  - `3` 无效命令
  
  - `4` 找不到命令字

返回示例

~~~json
{
    "cmd":-1,
    "err":0
}
~~~

### 重置命令缓冲区

连续发送5个换行符(\n)即可强制重置命令缓冲区，对于解决`0`报错时非常有效