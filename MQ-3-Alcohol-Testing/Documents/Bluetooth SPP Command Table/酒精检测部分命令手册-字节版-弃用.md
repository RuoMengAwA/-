# 酒精检测部分BLE命令手册

## 序

传输协议：蓝牙SSP透传/BLE透传 （不知道用哪个好）



## 命令和返回值格式

### 命令格式

命令以 `&`开头，紧接着一个**8位**的命令字 `<Command>`，部分命令可能含参数 `<Param>`，每个参数以 `#`开头，在命令的末尾以 `\n(回车符)`结尾。一条命令应类似于以下格式：

```
&<Command>[#[Param1]#[Param2]...]\n
```

注：“< >”为必选项，“[ ]”为可选项。

一条命令不应超过31个字节。

### 返回值格式

与命令格式类似，返回值以 `&`开头，紧接着一个8位的返回字 `<Return>`（与一般与对应的命令字相同），部分返回值可能含参数 `<Param>`，每个参数以 `#`开头，在命令的末尾以 `\n(回车符)`结尾。一条返回值应类似于以下格式：

```
&<Return>[#[Param1]#[Param2]...]\n
```

注：“< >”为必选项，“[ ]”为可选项。

一条返回不会超过31个字节。

### 示例

例如，发送一个命令字为0x02，参数为0x01的命令，发送的内容应如下

```
0x26 0x02 0x23 0x01 0x0A
(&)       (#)       (\n)
```

### 备注

所有涉及到字符串的传输中，所提到的字符串均不包含任何结束符





## 命令表

### 测试连接

用于测试连接是否正常，此命令只会返回0x26, 0x00, 0x0A。

**命令字** 0x00 无参数

**返回字** 0x00 无参数

### 获取版本

获取酒精检测部分的固件版本

- **命令字** 0x01 无参数
- **返回字** 0x01 参数1:固件版本字符串
- 备注 版本字符串类似于“Ver 0.0.1 Alpha”，长度不超过16个字符

### 弃用 | 设置打开或关闭电源

打开或关闭酒精检测部分的电源

- **命令字** 0x02
  - **参数1** 电源状态 8位无符号整数
    - 0x00 休眠
    - 0x01 启动
    - 其他值 不做改变
- **返回字** 0x02
  - **参数1** 设置后的电源状态 8位无符号整数
    - 0x00 休眠
    - 0x01 启动
- 备注 如果打开了自动休眠功能，即使不做干预也会自动打开或断开电源

### 弃用 | 设置自动打开或断开电源

设置是否启用自动电源功能，电源的逻辑是，驾驶员上车后自动打开，并在驾驶全程保持打开状态，直到驾驶员离开驾驶座一段时间后自动断开

- **命令字** 0x03
  - **参数1** 是否启用该功能 8位
    - 0x00 禁用
    - 0x01 启用
    - 其他值 不做改变
- **返回字** 0x03
  - **参数1** 设置后的状态 8位
    - 0x00 禁用
    - 0x01启用

### 弃用 | 获取电量

获取酒精检测的部分的电量

- **命令字** 0x04 无参数
- **返回字** 0x04
  - **参数1** 电量 8位
    - 0~100，表示百分比

### 弃用 | 获取充电状态

- **命令字** 0x05 无参数
- **返回字** 0x05
  - **参数1** 充电状态 8位
    - 0x00 放电
    - 0x01 太阳能充电
    - 0x02 线缆供电

### 弃用 | 获取驾驶员是否在座

- **命令字** 0x06 无参数
- **返回字** 0x06
  - **参数1** 驾驶员在座状态 8位
    - 0x00 不在座
    - 0x01 在座

### 开始酒精浓度检测

- **命令字** 0x07
  - **参数1** 返回方式
    - 0x00 不自动返回，即手动读取
    - 非0 检测完成自动返回，返回格式见“获取酒精检测结果”对应类型的返回方式
  - **参数2** 返回类型
    - 0x00 ADC源值
    - 0x01 空气酒精浓度换算结果
    - 0x02 血液酒精浓度换算结果
- **返回字** 0x07
  - **参数1** 8位
    - 0x00 传感器使用中（可能正在执行检测任务）
    - 0x01 开始检测
- 备注 酒精检测需要时间，结果不会立刻返回，可以选择得到结果后自动返回结果，或手动获取结果。另外，酒精检测会消耗大量电量，尽量避免频繁检测。

### 获取酒精检测结果(ADC源值)

返回最后一次酒精浓度检测的值，模数转换的结果

- **命令字** 0x08 无参数
- **返回字** 0x08
  - **参数1** 酒精浓度 16位
    - 0x0000~0x0FFF (0~4095) 酒精浓度系数
    - 0xFFFF (-1) 正在检测

### 重置/擦除

重置酒精检测模块的一切设置

- **命令字** 0x09
  - **参数1** 确认标志位 8位
    - 0xA5 重置
    - 其他值 不重置
- **返回字** 0x09
  - **参数1** 8位
    - 0x00 未重置（可能标志位错误）
    - 非0 准备开始重置
- 备注 在重置时系统会自动复位重启，蓝牙连接可能中断

### 弃用 | 设置蓝牙广播名称

- **命令字** 0x0A
  - **参数1** 广播名称 至多18字节
- **返回字** 0x0A 无参数

### 复位/重启

复位酒精检测模块

- **命令字** 0x0B
- **参数1** 确认标志位 8位
  - 0xA5 重置
  - 其他值 不重置
- **返回字** 0x0B
  - **参数1** 8位
    - 0x00 未复位（可能标志位错误）
    - 非0 准备开始复位
- 备注 复位后蓝牙连接可能断开

### 获取酒精检测结果(空气酒精浓度换算结果)

返回最后一次酒精浓度检测的值，经换算后的空气酒精浓度结果，单位mg/L

- **命令字** 0x0C 无参数
- **返回字** 0x0C
  - **参数1** 酒精浓度 64位 IEEE754标准下的双精确度浮点数
    - 非0xFFFFFFFFFFFFFFFF 酒精浓度
    - 0xFFFFFFFFFFFFFFFF（此值在IEEE754标准下不表示浮点数） 正在检测

### 获取酒精检测结果(血液酒精浓度换算结果)

返回最后一次酒精浓度检测的值，经换算后的血液酒精浓度结果，单位mg/100mL

- **命令字** 0x0D 无参数
- **返回字** 0x0D
  - **参数1** 酒精浓度 64位 IEEE754标准下的双精确度浮点数
    - 非0xFFFFFFFFFFFFFFFF 酒精浓度
    - 0xFFFFFFFFFFFFFFFF（此值在IEEE754标准下不表示浮点数） 正在检测

### 校正酒精检测传感器

需要在确认空气中无酒精时进行，硬件本身也会自动择机进行

- **命令字** 0x0E 无参数
- **返回字** 0x0E
  - **参数1** 8位
    - 0x00 传感器使用中（可能正在执行检测任务）
    - 0x01 开始校正



## 错误返回

当输入的命令有误时，会返回以下内容

- **返回字** 0xFF
  - **参数1** 错误
    - 0x00 不存在的命令
    - 0x01 命令过长
    - 0x02 命令接收不完整（找到起始字，但未找到结束字。此报错可能在前一条命令尚未发送结束字就发送起始字，或命令中混入起始字时出现）
    - 0x03 参数数目超过上限



## 附录

### 酒精检测结果ADC源值到空气浓度转换公式

$$
ADC校正值 ADC_{Base}\\
ADC当前值 ADC_{Cur}\\
ADC传感器输入电压换算值 ADC_U=6206\\
参考电阻 R_{Ref}=1k\\
传感器电阻校正值 R_{Base}=\frac{R_{Ref}(ADC_U-ADC_{Base})}{ADC_{Base}}\\
传感器电阻当前值 R_{Cur}\frac{R_{Ref}(ADC_U-ADC_{Cur})}{ADC_{Cur}}\\
传感器当前值与校正值之比 R_{Ratio}=\frac{R_{Cur}}{R_{base}}\\

根据手册提供数据使用该函数进行拟合\\
酒精浓度conc=d+\frac{a-d}{1+(\frac{R_{Ratio}}{c})^b}\\
其中，a=172384684415.19\\
b=1.21479420337627\\
c=2.42689583805007E-11\\
d=-0.0177145071258038
$$

