#include "spi.h"
#include "fk_oled.h"
#include "gpio.h"
#include "spi_flash.h"
#include "user_periph_setup.h"


unsigned char time_buff[5]={0,0,12,0,0};//时间 时-分
unsigned char date_buff[10]={2,0,1,8,10,0,0,10,0,0};//date year,month and day
unsigned char Heart_Rate[3]={0};//心率数据
unsigned char Steps[5] = {0,0,0,4,6};//步数
unsigned char Calorie[5] = {0,0,0,0,2};//卡路里
unsigned char Blood_p[11]={2,0,2,20,0,14,6};
unsigned char Blood_o[5]={16,16};
unsigned char Blood_s[3]={0,0,0};
extern unsigned char OLED_dis_flag;  //OLED显示开关标志位
extern unsigned char OLED_Page;			//OLED屏幕的页数
extern unsigned char dghData[20];
extern void DataConversion();
unsigned char show_picture[2048];
extern unsigned char power_level;
unsigned int target_address=0;
volatile bool first_oled=0;//是否是从第6屏进入第一屏  1：是  0：否

//阴码 逐行式 顺向  

//unsigned char typehead[416]={
//0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xF0,0x0C,0x18,0x18,0x0C,0x30,0x06,0x30,0x06,0x30,0x06,0x30,0x06,0x30,0x06,0x18,0x0C,0x0C,0x18,0x03,0xE0,0x00,0x00,0x00,0x00,/*"0",0*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x1F,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x1F,0xF8,0x00,0x00,0x00,0x00,/*"1",1*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xF0,0x18,0x1C,0x20,0x0C,0x30,0x0C,0x00,0x18,0x00,0x20,0x00,0xC0,0x03,0x00,0x0C,0x04,0x10,0x0C,0x3F,0xF8,0x00,0x00,0x00,0x00,/*"2",2*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xE0,0x30,0x38,0x30,0x18,0x00,0x30,0x03,0xC0,0x00,0x38,0x00,0x0C,0x00,0x0C,0x30,0x0C,0x30,0x38,0x0F,0xE0,0x00,0x00,0x00,0x00,/*"3",3*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0xF0,0x01,0x70,0x02,0x70,0x04,0x70,0x18,0x70,0x20,0x70,0x7F,0xFE,0x00,0x70,0x00,0x70,0x03,0xFE,0x00,0x00,0x00,0x00,/*"4",4*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xFC,0x08,0x00,0x08,0x00,0x10,0x00,0x17,0xF0,0x18,0x18,0x00,0x0C,0x00,0x0C,0x30,0x0C,0x20,0x38,0x1F,0xE0,0x00,0x00,0x00,0x00,/*"5",5*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xF8,0x0E,0x0C,0x18,0x00,0x10,0x00,0x33,0xF8,0x3C,0x0C,0x30,0x06,0x30,0x06,0x18,0x06,0x0C,0x0C,0x07,0xF0,0x00,0x00,0x00,0x00,/*"6",6*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFC,0x30,0x08,0x20,0x10,0x00,0x20,0x00,0x40,0x00,0x80,0x01,0x00,0x01,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x00,0x00,0x00,0x00,/*"7",7*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xF0,0x38,0x1C,0x30,0x0C,0x38,0x0C,0x0E,0x10,0x0D,0xE0,0x30,0x38,0x60,0x0C,0x60,0x0C,0x30,0x18,0x0F,0xE0,0x00,0x00,0x00,0x00,/*"8",8*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xE0,0x30,0x38,0x60,0x08,0x60,0x0C,0x60,0x0C,0x30,0x3C,0x1F,0xCC,0x00,0x18,0x00,0x18,0x30,0x70,0x1F,0xC0,0x00,0x00,0x00,0x00,/*"9",9*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"-",10*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x00,0x3C,0x00,0x00,0x00,0x00,0x00,/*".",11*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x03,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x03,0xC0,0x00,0x00,0x00,0x00,/*":",12*/
//};

//unsigned char typehead1632[832]={
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xE0,0x0E,0x70,
//0x1C,0x38,0x3C,0x3C,0x38,0x1C,0x78,0x1E,0x78,0x1E,0x78,0x1E,0x78,0x1E,0x78,0x1E,
//0x78,0x1E,0x78,0x1E,0x78,0x1E,0x78,0x1E,0x78,0x1E,0x78,0x1C,0x38,0x1C,0x3C,0x3C,
//0x1C,0x38,0x0E,0x70,0x07,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"0",0*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x01,0x80,
//0x1F,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,
//0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,
//0x01,0x80,0x03,0xC0,0x1F,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"1",1*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xE0,0x08,0x38,
//0x10,0x18,0x20,0x0C,0x20,0x0C,0x30,0x0C,0x30,0x0C,0x00,0x0C,0x00,0x18,0x00,0x10,
//0x00,0x20,0x00,0x40,0x00,0x80,0x01,0x00,0x02,0x00,0x04,0x04,0x08,0x04,0x10,0x04,
//0x20,0x0C,0x3F,0xF8,0x3F,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"2",2*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xC0,0x18,0x70,
//0x30,0x30,0x30,0x18,0x30,0x18,0x30,0x18,0x00,0x18,0x00,0x30,0x00,0x60,0x03,0xC0,
//0x00,0x70,0x00,0x18,0x00,0x08,0x00,0x0C,0x00,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x08,
//0x30,0x18,0x18,0x30,0x07,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"3",3*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x70,
//0x00,0x70,0x00,0xF0,0x01,0x70,0x01,0x70,0x02,0x70,0x06,0x70,0x04,0x70,0x08,0x70,
//0x08,0x70,0x10,0x70,0x20,0x70,0x20,0x70,0x7F,0xFE,0x00,0x70,0x00,0x70,0x00,0x70,
//0x00,0x70,0x00,0x70,0x00,0x70,0x03,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"4",4*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xFC,0x0F,0xFC,
//0x08,0x00,0x08,0x00,0x08,0x00,0x10,0x00,0x10,0x00,0x13,0xE0,0x14,0x30,0x18,0x18,
//0x10,0x08,0x00,0x0C,0x00,0x0C,0x00,0x0C,0x00,0x0C,0x30,0x0C,0x30,0x0C,0x20,0x18,
//0x20,0x18,0x10,0x30,0x0F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"5",5*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xF0,0x03,0x08,
//0x04,0x0C,0x08,0x0C,0x18,0x00,0x18,0x00,0x10,0x00,0x30,0x00,0x31,0xF0,0x36,0x18,
//0x3C,0x0C,0x38,0x06,0x30,0x06,0x30,0x06,0x30,0x06,0x30,0x06,0x18,0x06,0x18,0x04,
//0x0C,0x0C,0x06,0x18,0x03,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"6",6*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFC,0x1F,0xFC,
//0x38,0x08,0x30,0x10,0x20,0x10,0x20,0x20,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x80,
//0x00,0x80,0x00,0x80,0x01,0x00,0x01,0x00,0x01,0x00,0x03,0x00,0x03,0x00,0x03,0x00,
//0x03,0x00,0x03,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"7",7*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xE0,0x0C,0x30,
//0x18,0x18,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x38,0x0C,0x1C,0x18,0x0E,0x10,0x07,0xE0,
//0x0D,0xE0,0x18,0x70,0x30,0x38,0x60,0x1C,0x60,0x0C,0x60,0x0C,0x60,0x0C,0x60,0x0C,
//0x30,0x18,0x18,0x30,0x07,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"8",8*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xC0,0x18,0x20,
//0x30,0x10,0x30,0x18,0x60,0x08,0x60,0x0C,0x60,0x0C,0x60,0x0C,0x60,0x0C,0x60,0x1C,
//0x30,0x3C,0x18,0x6C,0x0F,0x8C,0x00,0x0C,0x00,0x18,0x00,0x18,0x00,0x18,0x30,0x30,
//0x30,0x60,0x30,0xC0,0x0F,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"9",9*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//0x7F,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"-",10*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x00,
//0x3C,0x00,0x3C,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*".",11*/
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x03,0xC0,0x03,0xC0,
//0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x80,
//0x03,0xC0,0x03,0xC0,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*":",12*/
//};
static void Delay_ms(unsigned long value)
{
	unsigned int i,j;
    for (i=0;i<value;i++)
		for (j=0;j<500;j++);
}

/* ***********************************************
	the value a indicate the command or the data
	the value b indicate the data which will be transmitted by spi .
*********************************************************/
void Write(unsigned char a,unsigned char b) 
{
	if(a)
		GPIO_SetActive(GPIO_PORT_2,GPIO_PIN_0);
	else
		GPIO_SetInactive(GPIO_PORT_2,GPIO_PIN_0);	
	lcd_cs_low();
	wdg_reload(WATCHDOG_DEFAULT_PERIOD);
	SetWord16(SPI_RX_TX_REG0, (unsigned char )b);		// write (low part of) dataToSend
		do
	{
	} while (GetBits16(SPI_CTRL_REG, SPI_INT_BIT) == 0);	// polling to wait for spi transmission
    
	SetWord16(SPI_CLEAR_INT_REG, 0x01);						// clear pending flag
	lcd_cs_high();
}


void set_position(unsigned char x1,unsigned char y1,unsigned char x2,unsigned char y2)
{
	Write(Command , 0x2A);     //Column Address Set
	Write(Parameter , 0x00);   
	Write(Parameter ,x1 );   //0
	Write(Parameter , 0x00);   
	Write(Parameter , x2);   //239

	Write(Command , 0x2B);     //Row Address Set
	Write(Parameter , 0x00);   
	Write(Parameter , y1);   //0
	Write(Parameter , 0x00);   
	Write(Parameter , y2);   //239
}

void draw_picture(unsigned char *buf,unsigned char x,unsigned char y)    
{
	unsigned char i,j;
	unsigned char * set_point=buf;
	Write(Command , 0x2C);     //memory write
	for(i=0;i<y;i++)
	{
		for(j=0;j<x;j++)
			{
				set_point=buf+2*i*x+2*j;
				Write(Parameter ,*set_point );
				set_point++;
				Write(Parameter ,*set_point );
			}
	}
}

void draw_picture1(unsigned char *buf,unsigned int length,unsigned char color_low,unsigned char color_high)
{
	unsigned char j,temp;
	unsigned int i;
	unsigned char *set_point=buf;
	
	Write(Command , 0x2C);     //memory write
	
	for(i=0;i<length;i++)
	{
		for(j=0;j<8;j++)
		{
			temp=((0x80>>j)&(*set_point));
			if(temp)
			{
				Write(Parameter ,color_high);
				Write(Parameter ,color_low);
			}
			else
			{
				Write(Parameter ,0x00);
				Write(Parameter ,0x00);
			}
		}
		set_point++;
	}
}
/*************************************************************
created by dgh
the function is used for cleaning the special range of the screen
**************************************************************/
void clean_screen(unsigned char x1,unsigned char y1,unsigned char x2,unsigned char y2)
{
	unsigned int length,i;
	unsigned char j;
	
	set_position(x1,y1,x2,y2);  
	Write(Command , 0x2C);     //memory write
	
	length =(x2-x1+1)*(y2-y1+1);
	for(i=0;i<length;i++)
	{
		/*
		debug by yao
		*/
		//for(j=0;j<8;j++)
		//{
			Write(Parameter ,0x00);
			Write(Parameter ,0x00);
		//}
	}
}
//=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
//  Initialization
//=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
void OLED_Init()
{
	unsigned char i ,j;
	GPIO_SetActive(GPIO_PORT_0,GPIO_PIN_4);	
			
	Delay_ms(120);                

	Write(Command , 0x11);                   //sleep out 

	Delay_ms(120);                

	Write(Command , 0x36);       // memory data access control
	Write(Parameter , 0x00);   

	Write(Command , 0x3A);     
	Write(Parameter , 0x05);  //0x05( 65K COLOR)

	//Write(Command , 0x39); 

	Write(Command , 0xB2);     //proch setting
	Write(Parameter , 0x0C);   
	Write(Parameter , 0x0C);   
	Write(Parameter , 0x00);   
	Write(Parameter , 0x33);   
	Write(Parameter , 0x33);   

	Write(Command , 0xB7);       //gate control
	Write(Parameter , 0x22);   

	Write(Command , 0xBB);       //vcom setting
	Write(Parameter , 0x36);   //0x3e???

	Write(Command , 0xC2);     //vdv and vrh command enable
	Write(Parameter , 0x01);   

	Write(Command , 0xC3);     //vrh set
	Write(Parameter , 0x19);   //GVDD=4.8V             //0x15

	Write(Command , 0xC4);     //vdv set
	Write(Parameter , 0x20);   //VDV, 0x20:0v

	Write(Command , 0xC6);      //frame rate control in normal mode
	Write(Parameter , 0x0F);   //0x0F:60Hz        	

	Write(Command , 0xD0);      //power control 1
	Write(Parameter , 0xA4);   
	Write(Parameter , 0xA1);   

	Write(Command , 0xE0);     //positive voitage gamma control
	Write(Parameter , 0x70);   
	Write(Parameter , 0x04);   
	Write(Parameter , 0x08);   
	Write(Parameter , 0x09);   
	Write(Parameter , 0x09);   
	Write(Parameter , 0x05);   
	Write(Parameter , 0x2A);   
	Write(Parameter , 0x33);   
	Write(Parameter , 0x41);   
	Write(Parameter , 0x07);   
	Write(Parameter , 0x13);   
	Write(Parameter , 0x13);   
	Write(Parameter , 0x29);   
	Write(Parameter , 0x2F);   

	Write(Command , 0xE1);     //negative voltage gamma control
	Write(Parameter , 0x70);   
	Write(Parameter , 0x03);   
	Write(Parameter , 0x09);   
	Write(Parameter , 0x0A);   
	Write(Parameter , 0x09);   
	Write(Parameter , 0x06);   
	Write(Parameter , 0x2B);   
	Write(Parameter , 0x34);   
	Write(Parameter , 0x41);   
	Write(Parameter , 0x07);   
	Write(Parameter , 0x12);   
	Write(Parameter , 0x14);   
	Write(Parameter , 0x28);   
	Write(Parameter , 0x2E);   

	Write(Command , 0x21);     //display inversion on

	Write(Command,0x13);
	Write(Command , 0x29);     //display on 

	Write(Command , 0x2A);     //Column Address Set
	Write(Parameter , 0x00);   
	Write(Parameter , 0x00);   //0
	Write(Parameter , 0x00);   
	Write(Parameter , 0xef);   //239

	Write(Command , 0x2B);     //Row Address Set
	Write(Parameter , 0x00);   
	Write(Parameter , 0x00);   //0
	Write(Parameter , 0x00);   
	Write(Parameter , 0xef);   //239

	Write(Command , 0x2C);     //memory write

	for(i=0;i<240;i++)
	{
		for(j=0;j<240;j++)
		{
			Write(Parameter,0x00);
			Write(Parameter,0x00);
		}
	}
}

/*
created by dgh 
this function is used to draw numbers.
*/
//void show_number1616(unsigned char x,unsigned char y,unsigned char *buf,unsigned char number,unsigned char color_low,unsigned char color_high)
//{
//	unsigned char i,j,k,start_x,end_x,temp;
//	unsigned char *set_point;
//	
//	for(i=0;i<number;i++)
//	{
//		set_point=typehead+32*(*(buf+i));
//		end_x =x+15+16*i;
//		start_x=x+16*i;
//		
//		set_position(start_x,y,end_x,y+15);
//		Write(Command , 0x2C);     //memory write
//		for(j=0;j<32;j++)
//		{
//			for(k=0;k<8;k++)
//			{
//				temp=((0x80>>k)&(*set_point));
//				if(temp)
//				{
//					Write(Parameter ,color_high);
//					Write(Parameter ,color_low);
//				}
//				else
//				{
//					Write(Parameter ,0x00);
//					Write(Parameter ,0x00);
//				}
//			}
//			set_point++;
//		}
//	}
//}

void show_number1632(unsigned char x,unsigned char y,unsigned char *buf,unsigned char number,unsigned char color_low,unsigned char color_high)
{
	unsigned char i,j,k,start_x,end_x,temp;
	unsigned char *set_point;
	unsigned char typehead1632[832];
	spi_flash_read_data(typehead1632,0x3fa00,832);    //read step picture address
	for(i=0;i<number;i++)
	{
		set_point=typehead1632+64*(*(buf+i));
		end_x =x+15+16*i;
		start_x=x+16*i;
		
		set_position(start_x,y,end_x,y+31);
		Write(Command , 0x2C);     //memory write
		for(j=0;j<64;j++)
		{
			for(k=0;k<8;k++)
			{
				temp=((0x80>>k)&(*set_point));
				if(temp)
				{
					Write(Parameter ,color_high);
					Write(Parameter ,color_low);
				}
				else
				{
					Write(Parameter ,0x00);
					Write(Parameter ,0x00);
				}
			}
			set_point++;
		}
	}
}

void show_number4896(unsigned char x,unsigned char y,unsigned char *buf,unsigned char number,unsigned char color_low,unsigned char color_high)
{
	unsigned char i,k,start_x,end_x,temp;
	unsigned int set_point,j;

	for(i=0;i<number;i++)
	{
		set_point=0x3b640+576*(*(buf+i));
		end_x =x+47+48*i;
		start_x=x+48*i;
		spi_flash_read_data(show_picture,set_point,576);    //read step picture address
		set_position(start_x,y,end_x,y+96);
		Write(Command , 0x2C);     //memory write
		for(j=0;j<576;j++)
		{
			for(k=0;k<8;k++)
			{
				temp=((0x80>>k)&(show_picture[j]));
				if(temp)
				{
					Write(Parameter ,color_high);
					Write(Parameter ,color_low);
				}
				else
				{
					Write(Parameter ,0x00);
					Write(Parameter ,0x00);
				}
			}
		}
	}
}

void show_number2448(unsigned char x,unsigned char y,unsigned char *buf,unsigned char number,unsigned char color_low,unsigned char color_high)
{
	unsigned char i,k,start_x,end_x,temp;
	unsigned int set_point,j;

	for(i=0;i<number;i++)
	{
		set_point=0x3af80+144*(*(buf+i));
		end_x =x+23+24*i;
		start_x=x+24*i;
		spi_flash_read_data(show_picture,set_point,144);    //read step picture address
		set_position(start_x,y,end_x,y+48);
		Write(Command , 0x2C);     //memory write
		for(j=0;j<144;j++)
		{
			for(k=0;k<8;k++)
			{
				temp=((0x80>>k)&(show_picture[j]));
				if(temp)
				{
					Write(Parameter ,color_high);
					Write(Parameter ,color_low);
				}
				else
				{
					Write(Parameter ,0x00);
					Write(Parameter ,0x00);
				}
			}
		}
	}
}

/*
the start point is (48,40)
the end point is (175,167)
*/
void oled_display(unsigned char count)
{
volatile	static bool display_off=0;
	if(count==7||count==0)
			GPIO_SetActive(backlight_port, backlight_pin);  //关背光
	else 
			GPIO_SetInactive(backlight_port, backlight_pin);	//开背光
	switch(count)
	{
		case 1:              //display time
//			if(display_off)
//			{
//				display_off =0;
//				Write(Command,0x29);     //display on 
//			}
//			else
//			{ if(first_oled)
//				{
//					first_oled=0;
					if(OLED_dis_flag == 1)
					{
						Write(Command,0x29);     //display on 
						DataConversion();
						time_buff[0]=dghData[2];
						time_buff[1]=dghData[3];
						time_buff[3]=dghData[4];
						time_buff[4]=dghData[5];
						
						date_buff[5]=dghData[6];
						date_buff[6]=dghData[7];
						date_buff[8]=dghData[8];
						date_buff[9]=dghData[9];
						OLED_dis_flag = 0;
						
						spi_flash_read_data(show_picture,0x3e000,512);    // read heart picture address		
						set_position(80,48+15,143,111+15);						
	//						set_position(48,16,175,143);
						draw_picture1(show_picture,512,0x00,0xf8);	
						Heart_Rate[0]=dghData[0]/100;
						Heart_Rate[1]=((dghData[0]/10)%10);
						Heart_Rate[2]=(dghData[0]%10);
						
						
						target_address=0x3cf00+64*power_level;
						spi_flash_read_data(show_picture,target_address,64);    
						set_position(199,10,230,25);
						draw_picture1(show_picture,64,0x00,0xf8);   //show batter
						
						show_number1632(0,0,date_buff,10,0x00,0xf8);
						show_number1632(0,32,time_buff,5,0x00,0xf8);
						
//						clean_screen (60,144,180,192);
//						clean_screen (60,192,180,240);
				//		clean_screen (84,180,156,228);
    				clean_screen (0,180,84,228);
						clean_screen (156,180,240,228);
						show_number2448(84,180,Heart_Rate,3,0x00,0xf8);
					
	//						show_number4896(0,130,time_buff,5,0x00,0xf8);
	//						show_number2448(0,80,date_buff,10,0x00,0xf8);
						
					}
			//	}
		//	}
			break;
		case 2:                //step
			if(OLED_dis_flag == 1)
					{
						OLED_dis_flag = 0;
						spi_flash_read_data(show_picture,0x3d000,512);    //read step picture address
						set_position(80,48+15,143,111+15);						
//						set_position(48,16,175,143);
						draw_picture1(show_picture,512,0x00,0xf8);
						show_number2448(60,180,Steps,5,0x00,0xf8);
					}
			break;
		case 3:          //cal
			if(OLED_dis_flag == 1)
					{
						OLED_dis_flag = 0;
						spi_flash_read_data(show_picture,0x3d800,512);    // read calorie picture address
						set_position(80,48+15,143,111+15);						
//						set_position(48,16,175,143);
						draw_picture1(show_picture,512,0x00,0xf8);
						show_number2448(60,180,Calorie,5,0x00,0xf8);
//						Show_pic6464(0, 0xf8, 0x00, 0x20, 0x10,1);		
//						  Show_pic64642(0, 0xf8, 0x00, 0x20, 0x10);	
//						Show_String816(Calorie, 5, 0xff, 0xff, 0x3f, 0x58);
					}
			break;
//		case 8:             //heart
//			if(OLED_dis_flag == 1)
//					{
////						clean_screen(0,80,240,128);
////						clean_screen(0,130,240,226);
//						OLED_dis_flag = 0;
//						
//					}
			break;
		case 6:
			if(OLED_dis_flag == 1)           // show blood presure picture
					{
						OLED_dis_flag = 0;
						spi_flash_read_data(show_picture,0x3ad80,512); 
						set_position(80,48+15,143,111+15);						
//						set_position(48,16,175,143);
						draw_picture1(show_picture,512,0x00,0xf8);
						Blood_p[0]=dghData[14]/100;
						Blood_p[1]=((dghData[14]/10)%10);
						Blood_p[2]=(dghData[14]%10);
						Blood_p[3]=11;
						Blood_p[4]=dghData[15];
						Blood_p[5]=10;
						Blood_p[6]=dghData[16]/100;
						Blood_p[7]=((dghData[16]/10)%10);
						Blood_p[8]=(dghData[16]%10);
						Blood_p[9]=11;
						Blood_p[10]=dghData[17];
						
						show_number2448(0,180,Blood_p,5,0x00,0xf8);
						if(Blood_p[6]==0)
						{	
							clean_screen (120,180,144,228);
							show_number2448(144,180,&Blood_p[7],4,0x00,0xf8);
						}
						else
							show_number2448(120,180,&Blood_p[6],5,0x00,0xf8);
					//	first_oled=1;
					}
			break;
		case 5:
			if(OLED_dis_flag == 1)    // show blood oxygen
					{
						OLED_dis_flag = 0;
						spi_flash_read_data(show_picture,0x3f800,512);    				
						set_position(80,48+15,143,111+15);						
//						set_position(48,16,175,143);
						draw_picture1(show_picture,512,0x00,0xf8);				
						Blood_o[0]=dghData[18]/100;
						Blood_o[1]=((dghData[18]/10)%10);
						Blood_o[2]=(dghData[18]%10);
						Blood_o[3]=11;
						Blood_o[4]=dghData[19];	
						show_number2448(60,180,Blood_o,5,0x00,0xf8);						
					}
			break;
		case 4:
			if(OLED_dis_flag == 1)   // show blood sugar
					{
						OLED_dis_flag = 0;
						spi_flash_read_data(show_picture,0x3e800,512);    				
						set_position(80,48+15,143,111+15);						
//						set_position(48,16,175,143);
						draw_picture1(show_picture,512,0x00,0xf8);
						clean_screen (120,180,144,228);
						show_number2448(84,180,Blood_s,5,0x00,0xf8);
					}
			break;
		case 7:
//			clean_screen(0,0,240,240);
		      	Write(Command,0x28);     //display off 
						GPIO_SetActive(backlight_port, backlight_pin);  //关背光
		     // 	display_off=1;
//	      		DataConversion();
//						time_buff[0]=dghData[2];
//						time_buff[1]=dghData[3];
//						time_buff[3]=dghData[4];
//						time_buff[4]=dghData[5];
//						
//						date_buff[5]=dghData[6];
//						date_buff[6]=dghData[7];
//						date_buff[8]=dghData[8];
//						date_buff[9]=dghData[9];
//						OLED_dis_flag = 0;
//						
//						spi_flash_read_data(show_picture,0x3e000,512);    // read heart picture address		
//						set_position(80,48+15,143,111+15);						
////						set_position(48,16,175,143);
//						draw_picture1(show_picture,512,0x00,0xf8);	
//						Heart_Rate[0]=dghData[0]/100;
//						Heart_Rate[1]=((dghData[0]/10)%10);
//						Heart_Rate[2]=(dghData[0]%10);
//						
//						
//						target_address=0x3cf00+64*power_level;
//						spi_flash_read_data(show_picture,target_address,64);    
//						set_position(199,10,230,25);
//						draw_picture1(show_picture,64,0x00,0xf8);   //show batter
//						
//						show_number1632(0,0,date_buff,10,0x00,0xf8);
//						show_number1632(0,32,time_buff,5,0x00,0xf8);
//						clean_screen (0,180,84,228);
//						clean_screen (156,180,240,228);
//						show_number2448(84,180,Heart_Rate,3,0x00,0xf8);
////						clean_screen (0,180,84,228);
////						clean_screen (156,180,240,228);
////						show_number2448(84,180,Heart_Rate,3,0x00,0xf8);
//						OLED_Page=0;
			break;
		default:
			break;
	}
}














